# Gateway Service Alert Rules
groups:
  - name: gateway-availability
    rules:
      # Service down
      - alert: GatewayServiceDown
        expr: up{job="docker-spring-boot-apps"} == 0
        for: 1m
        labels:
          severity: critical
          service: gateway
        annotations:
          summary: "Gateway service is down"
          description: "Gateway service has been down for more than 1 minute"

      # High error rate
      - alert: HighErrorRate
        expr: |
          sum(rate(app_requests_total{status_code=~"5.."}[5m])) 
          / sum(rate(app_requests_total[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
          service: gateway
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

      # Slow response times
      - alert: HighResponseLatency
        expr: |
          histogram_quantile(0.95, sum(rate(app_response_time_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "High response latency"
          description: "95th percentile latency is {{ $value }}s (threshold: 2s)"

  - name: gateway-authentication
    rules:
      # High authentication failure rate
      - alert: HighAuthenticationFailureRate
        expr: |
          sum(rate(app_authentication_total{result="failure"}[5m])) 
          / sum(rate(app_authentication_total[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "High authentication failure rate"
          description: "{{ $value | humanizePercentage }} of authentications are failing"

      # Token validation failures (potential attack)
      - alert: HighTokenValidationFailures
        expr: |
          sum(rate(app_token_validation_total{result=~"invalid|malformed"}[5m])) > 10
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "High invalid token attempts"
          description: "{{ $value }} invalid/malformed tokens per second - potential attack"

      # Expired tokens spike
      - alert: HighExpiredTokenRate
        expr: |
          sum(rate(app_token_validation_total{result="expired"}[5m])) 
          / sum(rate(app_token_validation_total[5m])) > 0.3
        for: 10m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "High expired token rate"
          description: "{{ $value | humanizePercentage }} of tokens are expired"

  - name: gateway-firestore
    rules:
      # Firestore high error rate
      - alert: FirestoreHighErrorRate
        expr: |
          sum(rate(app_firestore_operations_total{status="error"}[5m])) 
          / sum(rate(app_firestore_operations_total[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
          service: gateway
        annotations:
          summary: "High Firestore error rate"
          description: "{{ $value | humanizePercentage }} of Firestore operations are failing"

      # Firestore slow queries
      - alert: FirestoreSlowQueries
        expr: |
          histogram_quantile(0.95, sum(rate(app_firestore_operation_duration_seconds_bucket[5m])) by (le, collection)) > 1
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "Slow Firestore queries"
          description: "95th percentile Firestore latency is {{ $value }}s"

  - name: gateway-rate-limiting
    rules:
      # High rate limit violations
      - alert: HighRateLimitViolations
        expr: sum(rate(app_rate_limit_exceeded_total[5m])) > 10
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "High rate limit violations"
          description: "{{ $value }} rate limit violations per second"

  - name: gateway-circuit-breaker
    rules:
      # Circuit breaker open
      - alert: CircuitBreakerOpen
        expr: app_circuitbreaker_state{state="OPEN"} == 1
        for: 1m
        labels:
          severity: critical
          service: gateway
        annotations:
          summary: "Circuit breaker {{ $labels.name }} is OPEN"
          description: "Circuit breaker has opened - downstream service may be unavailable"

      # Circuit breaker half-open (recovering)
      - alert: CircuitBreakerHalfOpen
        expr: app_circuitbreaker_state{state="HALF_OPEN"} == 1
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "Circuit breaker {{ $labels.name }} is HALF_OPEN"
          description: "Circuit breaker is in recovery state for over 5 minutes"

  - name: gateway-cache
    rules:
      # Low cache hit rate
      - alert: LowCacheHitRate
        expr: |
          sum(rate(app_cache_hits_total[5m])) 
          / (sum(rate(app_cache_hits_total[5m])) + sum(rate(app_cache_misses_total[5m]))) < 0.7
        for: 10m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }} (threshold: 70%)"

  - name: gateway-resources
    rules:
      # Slow startup
      - alert: SlowStartup
        expr: app_startup_time_milliseconds > 60000
        for: 0m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "Slow application startup"
          description: "Application took {{ $value }}ms to start (threshold: 60s)"

      # High JVM heap usage
      - alert: HighHeapUsage
        expr: |
          sum(jvm_memory_used_bytes{area="heap"})
          / sum(jvm_memory_max_bytes{area="heap"}) > 0.85
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "High JVM heap usage"
          description: "JVM heap usage is {{ $value | humanizePercentage }} (threshold: 85%)"

      # Critical JVM heap usage
      - alert: CriticalHeapUsage
        expr: |
          sum(jvm_memory_used_bytes{area="heap"})
          / sum(jvm_memory_max_bytes{area="heap"}) > 0.95
        for: 2m
        labels:
          severity: critical
          service: gateway
        annotations:
          summary: "Critical JVM heap usage"
          description: "JVM heap usage is {{ $value | humanizePercentage }} - OOM risk!"

      # High CPU usage
      - alert: HighCpuUsage
        expr: process_cpu_usage > 0.8
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value | humanizePercentage }} (threshold: 80%)"

      # High GC pause time
      - alert: HighGcPauseTime
        expr: |
          rate(jvm_gc_pause_seconds_sum[5m])
          / rate(jvm_gc_pause_seconds_count[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "High GC pause time"
          description: "Average GC pause time is {{ $value }}s"

      # Too many threads
      - alert: HighThreadCount
        expr: jvm_threads_live_threads > 500
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "High thread count"
          description: "{{ $value }} live threads (threshold: 500)"

  - name: gateway-sessions
    rules:
      # Session anomaly - sudden spike
      - alert: SessionSpike
        expr: |
          (app_sessions_active - app_sessions_active offset 5m)
          / app_sessions_active offset 5m > 0.5
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "Unusual session spike"
          description: "Active sessions increased by {{ $value | humanizePercentage }} in 5 minutes"

      # Session anomaly - sudden drop
      - alert: SessionDrop
        expr: |
          (app_sessions_active offset 5m - app_sessions_active)
          / app_sessions_active offset 5m > 0.5
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "Unusual session drop"
          description: "Active sessions decreased by {{ $value | humanizePercentage }} in 5 minutes"

      # High session revocation rate
      - alert: HighSessionRevocationRate
        expr: |
          sum(rate(app_sessions_revoked[5m]))
          / sum(rate(app_sessions_created[5m])) > 0.5
        for: 10m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "High session revocation rate"
          description: "{{ $value | humanizePercentage }} of sessions are being revoked"

  - name: gateway-users
    rules:
      # High user deletion rate
      - alert: HighUserDeletionRate
        expr: sum(rate(app_users_deleted[5m])) > 1
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "High user deletion rate"
          description: "{{ $value }} users being deleted per second"

      # Login failure spike
      - alert: LoginFailureSpike
        expr: |
          sum(rate(app_authentication_total{result="failure"}[5m]))
          / sum(rate(app_authentication_total{result="failure"}[1h])) > 3
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "Login failure spike detected"
          description: "Login failures are 3x higher than the hourly average - potential attack"

  - name: gateway-slo
    rules:
      # SLO: Availability (99.9%)
      - alert: SloAvailabilityBreach
        expr: |
          (1 - sum(rate(http_server_requests_seconds_count{status=~"5.."}[1h]))
          / sum(rate(http_server_requests_seconds_count[1h]))) < 0.999
        for: 5m
        labels:
          severity: critical
          service: gateway
        annotations:
          summary: "SLO availability breach"
          description: "Availability is {{ $value | humanizePercentage }} (SLO: 99.9%)"

      # SLO: Latency P99 < 1s
      - alert: SloLatencyBreach
        expr: |
          histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket[1h])) by (le)) > 1
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "SLO latency breach"
          description: "P99 latency is {{ $value }}s (SLO: < 1s)"

  - name: gateway-traffic
    rules:
      # Traffic anomaly - sudden drop
      - alert: TrafficDrop
        expr: |
          sum(rate(http_server_requests_seconds_count[5m]))
          / sum(rate(http_server_requests_seconds_count[1h])) < 0.1
        for: 5m
        labels:
          severity: critical
          service: gateway
        annotations:
          summary: "Significant traffic drop"
          description: "Traffic is 90% lower than the hourly average"

      # No traffic at all
      - alert: NoTraffic
        expr: sum(rate(http_server_requests_seconds_count[5m])) == 0
        for: 5m
        labels:
          severity: critical
          service: gateway
        annotations:
          summary: "No traffic detected"
          description: "No HTTP requests received in the last 5 minutes"

      # High 4xx error rate (client errors)
      - alert: High4xxErrorRate
        expr: |
          sum(rate(http_server_requests_seconds_count{status=~"4.."}[5m]))
          / sum(rate(http_server_requests_seconds_count[5m])) > 0.2
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "High client error rate"
          description: "{{ $value | humanizePercentage }} of requests are returning 4xx errors"
