services:
  # Firestore Emulator for local development
  firestore:
    build:
      context: ./firestore-emulator
      dockerfile: Dockerfile
    container_name: firestore-emulator
    command: >
      bash -c "mkdir -p /opt/data &&
      gcloud beta emulators firestore start
      --host-port=0.0.0.0:8080
      --project=grow-with-freya-dev"
    ports:
      - "8082:8080"  # Firestore emulator on port 8082
      - "4000:4000"  # Firestore UI (if enabled)
    volumes:
      - firestore-data:/opt/data  # Persist Firestore data
    environment:
      FIRESTORE_EMULATOR_CACHE_DIR: /opt/data
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/8080'"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 10s
    networks:
      - default-network

  gateway-service:
    build: gateway-service
    profiles:
      - default
      - func-tests
    ports:
      - "8080:8080"
    networks:
      - default-network
    labels:
      prometheus-scrape: "true"
    restart: always
    env_file:
      - gateway-service/.env
    environment:
      SPRING_PROFILES_ACTIVE: dev
      FIREBASE_EMULATOR_HOST: firestore
      FIREBASE_EMULATOR_PORT: 8080
    depends_on:
      firestore:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://gateway-service:8080/private/healthcheck"]
      interval: 5s
      timeout: 3s
      retries: 20

  func-tests:
    build:
      context: ./func-tests
    profiles:
      - func-tests
    image: func-tests:latest
    networks:
      - default-network
    depends_on:
      gateway-service:
        condition: service_healthy
    environment:
      BACKEND_URL_GATEWAY_SERVICE: http://gateway-service:8080
    volumes:
      - ./func-tests/build/reports:/app/build/reports

  # Gateway with rate limiting disabled for NFT
  gateway-service-nft:
    build:
      context: ./gateway-service
    profiles:
      - nft
    image: gateway-service:latest
    ports:
      - "8081:8080"
    networks:
      - default-network
    env_file:
      - gateway-service/.env
    environment:
      SPRING_PROFILES_ACTIVE: dev
      FIREBASE_EMULATOR_HOST: firestore
      FIREBASE_EMULATOR_PORT: 8080
      APP_SECURITY_RATE_LIMIT_ENABLED: "false"
    depends_on:
      firestore:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://gateway-service-nft:8080/private/healthcheck"]
      interval: 5s
      timeout: 3s
      retries: 20

  nft:
    build:
      context: ./nft
    profiles:
      - nft
    image: nft:latest
    depends_on:
      gateway-service-nft:
        condition: service_healthy
    environment:
      GATEWAY_BASE_URL: http://gateway-service-nft:8080
    networks:
      - default-network
    volumes:
      - ./nft/build/reports:/app/build/reports

  prometheus:
    image: prom/prometheus
    ports:
      - '9090:9090'
    user: root
    # links:
    #   - alertmanager
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # For service discovery
      - ./prometheus:/etc/prometheus
    extra_hosts:
      - 'host.docker.internal:host-gateway' 
    command:
      - '--config.file=/etc/prometheus/prometheus-dev.yml'
    restart: always
    networks:
      - default-network
  
  # alertmanager: # Note to sell, will do this later once deployed to cloud / can sensible store email to send messages to.
  #   image: prom/alertmanager
  #   ports:
  #     - '9093:9093'
  #   volumes:
  #     - ./alertmanager:/etc/alertmanager
  #   command:
  #     - '--config.file=/etc/alertmanager/alertmanager.yml'
  #   restart: always
  
  # grafana:
  #   image: grafana/grafana-enterprise
  #   ports:
  #     - '3000:3000'
  #   depends_on:
  #     - prometheus
  #   environment:
  #     #      - GF_SERVER_ROOT_URL=http://my.grafana.server/
  #     #      - GF_INSTALL_PLUGINS=grafana-clock-panel
  #     - GF_INSTALL_PLUGINS=grafana-piechart-panel
  #   volumes:
  #     - './grafana/datasources:/etc/grafana/provisioning/datasources'
  #     - './grafana/dashboards/dashboards.yml:/etc/grafana/provisioning/dashboards/main.yml'
  #     - './grafana/dashboard-backup/:/var/lib/grafana/dashboards'
  #   networks:
  #     - default-network
  
networks:
  default-network:
    driver: bridge

volumes:
  firestore-data:
    driver: local