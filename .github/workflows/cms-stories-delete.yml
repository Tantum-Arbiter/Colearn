name: CMS Story Delete

on:
  workflow_dispatch:
    inputs:
      story_id:
        description: 'Story ID to delete (e.g., wizard-school)'
        required: true
        type: string
      confirm_delete:
        description: 'Type the story ID again to confirm deletion'
        required: true
        type: string
      dry_run:
        description: 'Dry run (show what would be deleted)'
        required: true
        default: true
        type: boolean

jobs:
  validate-deletion:
    name: Validate Deletion Request
    runs-on: ubuntu-latest
    outputs:
      story_exists_gcs: ${{ steps.check.outputs.gcs_exists }}
      story_exists_firestore: ${{ steps.check.outputs.firestore_exists }}

    steps:
      - name: Verify confirmation matches
        run: |
          if [ "${{ github.event.inputs.story_id }}" != "${{ github.event.inputs.confirm_delete }}" ]; then
            echo "ERROR: Confirmation does not match story ID"
            echo "Story ID: ${{ github.event.inputs.story_id }}"
            echo "Confirmation: ${{ github.event.inputs.confirm_delete }}"
            exit 1
          fi
          echo "Confirmation verified for story: ${{ github.event.inputs.story_id }}"

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Check if story exists
        id: check
        run: |
          STORY_ID="${{ github.event.inputs.story_id }}"
          
          echo "Checking GCS bucket..."
          if gsutil ls "gs://colearnwithfreya-assets/stories/${STORY_ID}/" 2>/dev/null; then
            echo "gcs_exists=true" >> $GITHUB_OUTPUT
            echo "Found in GCS: gs://colearnwithfreya-assets/stories/${STORY_ID}/"
            gsutil ls -r "gs://colearnwithfreya-assets/stories/${STORY_ID}/"
          else
            echo "gcs_exists=false" >> $GITHUB_OUTPUT
            echo "Not found in GCS"
          fi

  delete-story:
    name: Delete Story
    runs-on: ubuntu-latest
    needs: validate-deletion
    if: github.event.inputs.dry_run == 'false'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: scripts
        run: npm install

      - name: Delete from GCS
        if: needs.validate-deletion.outputs.story_exists_gcs == 'true'
        run: |
          STORY_ID="${{ github.event.inputs.story_id }}"
          echo "Deleting from GCS: gs://colearnwithfreya-assets/stories/${STORY_ID}/"
          gsutil -m rm -r "gs://colearnwithfreya-assets/stories/${STORY_ID}/"
          echo "Deleted from GCS"

      - name: Delete from Firestore
        working-directory: scripts
        run: |
          node -e "
          const admin = require('firebase-admin');
          const serviceAccount = JSON.parse(Buffer.from(process.env.GCP_SA_KEY, 'base64').toString('utf8'));
          admin.initializeApp({ credential: admin.credential.cert(serviceAccount) });
          const db = admin.firestore();
          
          async function deleteStory() {
            const storyId = '${{ github.event.inputs.story_id }}';
            const docRef = db.collection('stories').doc(storyId);
            const doc = await docRef.get();
            
            if (doc.exists) {
              await docRef.delete();
              console.log('Deleted from Firestore:', storyId);
            } else {
              console.log('Story not found in Firestore:', storyId);
            }
          }
          
          deleteStory().then(() => process.exit(0)).catch(e => { console.error(e); process.exit(1); });
          "
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

      - name: Create deletion summary
        run: |
          echo "## Story Deleted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Story ID**: \`${{ github.event.inputs.story_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deleted from GCS**: ${{ needs.validate-deletion.outputs.story_exists_gcs }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deleted from Firestore**: Yes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deleted by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY

