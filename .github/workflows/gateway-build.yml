name: Gateway Build and Push

on:
  push:
    paths:
      - 'gateway-service/**'
      - '.github/workflows/gateway-build.yml'

permissions:
  contents: write

env:
  IMAGE_NAME: gateway-service
  REGION: europe-west1
  PROJECT_ID: apt-icon-472307-b7
  SERVICE: gateway-service

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.build.outputs.version }}
    steps:
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Docker for GAR
        run: gcloud auth configure-docker europe-west1-docker.pkg.dev --quiet

      - id: build
        working-directory: gateway-service
        run: |
          PATCH=$(git rev-list --count HEAD)
          VERSION="0.0.$PATCH"
          GAR_REPO="europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/artifact-repo/${{ env.IMAGE_NAME }}"
          GAR_IMAGE="$GAR_REPO:$VERSION"
          GAR_LATEST="$GAR_REPO:latest"
                            
          docker build -t $GAR_IMAGE -t $GAR_LATEST .
          docker push $GAR_IMAGE
          docker push $GAR_LATEST
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "DEBUG: Built and pushed $GAR_IMAGE and $GAR_LATEST"

  deploy-functional:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Debug GAR image url
        run: |
          echo "DEBUG: Deploying image=europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/artifact-repo/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.version }}"

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy $SERVICE \
          --image "europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/artifact-repo/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.version }}" \
          --region ${{ env.REGION }} \
          --project ${{ env.PROJECT_ID }} \
          --service-account svc-deploy-functional@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
          --no-allow-unauthenticated
