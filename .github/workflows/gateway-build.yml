name: Gateway Build and Push

on:
  push:
    paths:
      - 'gateway-service/**'
      - '.github/workflows/gateway-build.yml'

permissions:
  contents: write

env:
  IMAGE_NAME: gateway-service
  REGION: europe-west1
  PROJECT_ID: apt-icon-472307-b7
  SERVICE: gateway-service

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.build.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Docker login to Artifact Registry
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' | \
            docker login -u _json_key --password-stdin \
            https://europe-west1-docker.pkg.dev

      - id: build
        working-directory: gateway-service
        run: |
          PATCH=$(git rev-list --count HEAD)
          VERSION="0.0.$PATCH"
          GAR_REPO="europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/artifact-repo/${{ env.IMAGE_NAME }}"
          GAR_IMAGE="$GAR_REPO:$VERSION"
          GAR_LATEST="$GAR_REPO:latest"
          
          echo "DEBUG: VERSION=$VERSION"
          echo "DEBUG: GAR_IMAGE=$GAR_IMAGE"
          echo "DEBUG: GAR_LATEST=$GAR_LATEST"

          docker build -t $GAR_IMAGE -t $GAR_LATEST .
          docker push $GAR_IMAGE
          docker push $GAR_LATEST

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "DEBUG: Built and pushed $GAR_IMAGE and $GAR_LATEST"

  deploy-functional-gateway:
  needs: deploy-functional
  runs-on: ubuntu-latest
  outputs:
    config_name: ${{ steps.deploy_config.outputs.config_name }}

  steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Authenticate with GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Render OpenAPI config
      run: |
        mkdir -p infra/rendered
        envsubst < infra/openapi.template.yaml > infra/rendered/openapi.yaml
      env:
        BACKEND_URL: ${{ secrets.BACKEND_URL_GATEWAY_SERVICE }}
        GATEWAY_HOST: ${{ secrets.GATEWAY_HOST }}

    - name: Ensure API exists
      run: |
        gcloud api-gateway apis describe gateway-functional \
          --project=${{ env.PROJECT_ID }} || \
        gcloud api-gateway apis create gateway-functional \
          --project=${{ env.PROJECT_ID }}

    - name: Deploy API config
      id: deploy_config
      run: |
        CONFIG_NAME="gateway-config-functional-$(date +%s)"
        gcloud api-gateway api-configs create $CONFIG_NAME \
          --api=gateway-functional \
          --openapi-spec=infra/rendered/openapi.yaml \
          --project=${{ env.PROJECT_ID }} \
          --backend-auth-service-account=${{ secrets.SERVICE_ACCOUNT_EMAIL }} \
          --display-name="Functional Gateway Config $CONFIG_NAME"

        echo "CONFIG_NAME=$CONFIG_NAME" >> $GITHUB_ENV

    - name: Deploy or update Gateway
      run: |
        CONFIG_NAME=${{ steps.deploy_config.outputs.config_name }}
        if gcloud api-gateway gateways describe gateway-functional \
          --location=${{ env.REGION }} \
          --project=${{ env.PROJECT_ID }} > /dev/null 2>&1; then
          echo "Updating existing gateway..."
          gcloud api-gateway gateways update gateway-functional \
            --api=gateway-functional \
            --api-config=$CONFIG_NAME \
            --location=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }}
        else
          echo "Creating new gateway"
          gcloud api-gateway gateways create gateway-functional \
            --api=gateway-functional \
            --api-config=$CONFIG_NAME \
            --location=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }}
        fi

  deploy-functional:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Debug GAR image url
        run: |
          echo "DEBUG: Deploying image=europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/artifact-repo/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image_tag }}"

      - name: Check if version is available
        run: |
          echo "VERSION=${{ needs.build-and-push.outputs.image_tag }}"

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy $SERVICE \
          --image "europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/artifact-repo/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image_tag }}" \
          --region ${{ env.REGION }} \
          --project ${{ env.PROJECT_ID }} \
          --service-account svc-deploy-functional@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
          --no-allow-unauthenticated

  run-functional-tests:
    needs: deploy-functional
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Re-deploy Cloud Run Job with latest test image
        run: |
          echo "Redeploying job: gateway-functional-test-job"
          gcloud run jobs deploy gateway-functional-test-job \
            --image "europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/artifact-repo/gateway-functional-test:latest" \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --service-account svc-deploy-functional@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
            --memory=2Gi \
            --cpu=2 \
            --max-retries=0 \
            --task-timeout=300s

      - name: Execute Cloud Run Job
        id: execute-tests
        run: |
          echo "Executing Cloud Run Job: gateway-functional-test-job"
          JOB_NAME=$(gcloud run jobs execute gateway-functional-test-job \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --wait \
            --format="value(metadata.name)")
  
          echo "JOB_NAME=$JOB_NAME" >> $GITHUB_ENV

      - name: Print Logs from Cloud Run Job
        run: |
          echo "Fetching logs from execution: $JOB_NAME"
  
          gcloud logging read "resource.type=cloud_run_job AND resource.labels.execution_name=$JOB_NAME" \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --limit=1000 \
            --format="value(textPayload)"
  

#      - name: Cleanup previous instance
#        run: |
#          gcloud run revisions list \
#            --service=$SERVICE \
#            --region=$REGION \
#            --format="value(metadata.name,status.traffic[0].percent)" \
#            --project=$PROJECT_ID | \
#          while read revision traffic; do
#            if [[ "$traffic" == "0" ]]; then
#              echo "Deleting previous instance: $revision"
#              gcloud run revisions delete "$revision" \
#                --region=$REGION \
#                --project=$PROJECT_ID \
#                --quiet
#            fi
#          done