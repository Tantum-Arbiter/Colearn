name: Gateway Build and Push

on:
  workflow_dispatch:
  push:
    paths:
      - 'gateway-service/**'
      - '.github/workflows/gateway-build.yml'
      - 'infra/**'
      - 'func-tests/**'

# CRITICAL: Add concurrency control to prevent queuing issues
concurrency:
  group: gateway-build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  IMAGE_NAME: gateway-service
  REGION: europe-west1
  PROJECT_ID: apt-icon-472307-b7
  SERVICE: gateway-service

jobs:
  build-and-push:
    runs-on: ubuntu-latest 
    outputs:
      image_tag: ${{ steps.build.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Docker login to Artifact Registry
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' | docker login -u _json_key --password-stdin https://europe-west1-docker.pkg.dev

      - name: Build and Push Docker Images
        id: build
        working-directory: gateway-service
        run: |
          PATCH=$(git rev-list --count HEAD)
          VERSION="0.0.$PATCH"
          GAR_REPO="europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/artifact-repo/${{ env.IMAGE_NAME }}"
          GAR_IMAGE="$GAR_REPO:$VERSION"
          GAR_LATEST="$GAR_REPO:latest"

          echo "DEBUG: VERSION=$VERSION"
          echo "DEBUG: GAR_IMAGE=$GAR_IMAGE"
          echo "DEBUG: GAR_LATEST=$GAR_LATEST"

          docker build -t $GAR_IMAGE -t $GAR_LATEST .
          docker push $GAR_IMAGE
          docker push $GAR_LATEST

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "DEBUG: Built and pushed $GAR_IMAGE and $GAR_LATEST"

  deploy-functional:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Debug GAR image url
        run: |
          echo "DEBUG: Deploying image=europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/artifact-repo/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image_tag }}"

      - name: Check if version is available
        run: |
          echo "VERSION=${{ needs.build-and-push.outputs.image_tag }}"

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy $SERVICE \
            --image "europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/artifact-repo/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image_tag }}" \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --service-account gateway-dev-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
            --ingress internal-and-cloud-load-balancing \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --timeout 300 \
            --set-env-vars "SPRING_PROFILES_ACTIVE=gcp-dev,FIREBASE_PROJECT_ID=${{ env.PROJECT_ID }},GCS_PROJECT_ID=${{ env.PROJECT_ID }},GCS_BUCKET=colearnwithfreya-assets,BACKEND_URL_GATEWAY_SERVICE=${{ secrets.BACKEND_URL_GATEWAY_SERVICE }}"

  run-functional-tests:
    needs: deploy-functional
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Set up Node.js for Firebase token generation
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate Firebase ID Token for functional tests
        id: firebase-token
        run: |
          # Install Firebase Admin SDK
          npm install firebase-admin

          # Create script to generate custom token and exchange for ID token
          cat > generate-token.js << 'EOF'
          const admin = require('firebase-admin');

          // Initialize with service account from environment
          const serviceAccount = JSON.parse(process.env.FIREBASE_SA_KEY);
          admin.initializeApp({
            credential: admin.credential.cert(serviceAccount),
            projectId: serviceAccount.project_id
          });

          async function generateIdToken() {
            try {
              // Create a custom token for a test user
              const customToken = await admin.auth().createCustomToken('func-test-user', {
                testUser: true
              });

              // Exchange custom token for ID token using Firebase Auth REST API
              const response = await fetch(
                `https://identitytoolkit.googleapis.com/v1/accounts:signInWithCustomToken?key=${process.env.FIREBASE_WEB_API_KEY}`,
                {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    token: customToken,
                    returnSecureToken: true
                  })
                }
              );

              if (!response.ok) {
                const error = await response.text();
                console.error('Firebase Auth API error:', error);
                process.exit(1);
              }

              const data = await response.json();
              // Output the ID token (masked in logs)
              console.log(`::add-mask::${data.idToken}`);
              console.log(`firebase_id_token=${data.idToken}`);
            } catch (error) {
              console.error('Error generating token:', error);
              process.exit(1);
            }
          }

          generateIdToken();
          EOF

          # Run the script and capture output
          OUTPUT=$(node generate-token.js)
          FIREBASE_ID_TOKEN=$(echo "$OUTPUT" | grep "firebase_id_token=" | cut -d'=' -f2)

          # Set as output (masked)
          echo "::add-mask::$FIREBASE_ID_TOKEN"
          echo "token=$FIREBASE_ID_TOKEN" >> $GITHUB_OUTPUT
        env:
          FIREBASE_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          FIREBASE_WEB_API_KEY: ${{ secrets.FIREBASE_WEB_API_KEY }}

      - name: Debug Gateway API URL
        run: |
          echo "BACKEND_URL_GATEWAY_SERVICE = ${{ secrets.BACKEND_URL_GATEWAY_SERVICE }}"
          echo "GATEWAY_AUDIENCE = ${{ secrets.GATEWAY_AUDIENCE }}"
          echo "Firebase token generated: ${{ steps.firebase-token.outputs.token != '' }}"

      - name: Re-deploy Cloud Run Job with latest test image
        run: |
          echo "Redeploying job: gateway-functional-test-job"
          gcloud run jobs deploy gateway-functional-test-job \
            --image "europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/artifact-repo/gateway-functional-test:latest" \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --service-account svc-deploy-functional@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
            --memory=2Gi \
            --cpu=2 \
            --max-retries=0 \
            --task-timeout=300s \
            --set-env-vars "GATEWAY_BASE_URL=${{ secrets.BACKEND_URL_GATEWAY_SERVICE }},CUCUMBER_TAGS=@gcp-dev and not @emulator-only,TEST_ENV=gcp,GCP_FIREBASE_ID_TOKEN=${{ steps.firebase-token.outputs.token }},GCS_REPORTS_BUCKET=colearnwithfreya-test-reports"

      - name: Execute Cloud Run Job
        id: execute-tests
        run: |
          echo "Executing Cloud Run Job: gateway-functional-test-job"
          JOB_NAME=$(gcloud run jobs execute gateway-functional-test-job \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --wait \
            --format="value(metadata.name)") || true

          echo "JOB_NAME=$JOB_NAME" >> $GITHUB_ENV

      - name: Fetch and Display Test Results
        if: always()
        run: |
          echo "## ðŸ§ª Functional Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Give logs a moment to be available
          sleep 5

          # Fetch logs from the most recent job execution
          gcloud logging read 'resource.type="cloud_run_job" AND resource.labels.job_name="gateway-functional-test-job"' \
            --limit=500 \
            --format="value(textPayload)" \
            --project=${{ env.PROJECT_ID }} \
            --freshness=10m > test-output.log 2>&1 || true

          # Check if we got any output
          if [ ! -s test-output.log ]; then
            echo "âš ï¸ No logs retrieved from Cloud Run Job" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Extract Cucumber summary (scenarios and steps lines)
          echo "### Test Summary" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -E "^[0-9]+ (Scenarios?|Steps?)" test-output.log | head -5 >> $GITHUB_STEP_SUMMARY || echo "No summary found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for pass/fail
          if grep -qE "[0-9]+ Scenarios? \([0-9]+ passed\)$" test-output.log; then
            echo "âœ… **All scenarios passed!**" >> $GITHUB_STEP_SUMMARY
          elif grep -q "failed" test-output.log; then
            echo "âŒ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Failed Scenarios" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -B5 "FAILED\|failed\|AssertionError" test-output.log | head -50 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Check logs for details**" >> $GITHUB_STEP_SUMMARY
          fi

          # Show last 30 lines for context
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>ðŸ“‹ Last 30 log lines</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 test-output.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

          # Add link to HTML report
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **[View Full HTML Report](https://storage.cloud.google.com/colearnwithfreya-test-reports/latest/cucumber.html)**" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup previous instance
        run: |
          gcloud run revisions list \
            --service=$SERVICE \
            --region=$REGION \
            --format="value(metadata.name,status.traffic[0].percent)" \
            --project=$PROJECT_ID | \
          while read revision traffic; do
            if [[ "$traffic" == "0" ]]; then
              echo "Deleting previous instance: $revision"
              gcloud run revisions delete "$revision" \
                --region=$REGION \
                --project=$PROJECT_ID \
                --quiet
            fi
          done
